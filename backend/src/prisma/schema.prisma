// This is your Prisma schema file for Real Estate Property Management SaaS
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// SYSTEM & AUDIT
// ============================================

// Organization/Tenant model - represents each company/organization in the system
model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique // For URL identification

  // Subdomain configuration
  subdomain    String? @unique // e.g., "company1" from company1.tuhame.co.ke
  customDomain String? @unique // e.g., "app.company1.com"

  isActive Boolean @default(true)

  // Subscription
  plan          String @default("FREE") // FREE, STARTER, PROFESSIONAL, ENTERPRISE
  maxUsers      Int    @default(3)
  maxProperties Int    @default(10)

  // Branding (optional white-label)
  logoUrl      String?
  primaryColor String?

  // Contact
  contactEmail String?
  contactPhone String?

  // Relationships
  users      User[]
  properties Property[]
  tenants    Tenant[]
  landlords  Landlord[]
  leases     Lease[]
  invoices   Invoice[]
  payments   Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([subdomain])
  @@map("organizations")
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  firstName String
  lastName  String
  phone     String?

  // Authentication
  passwordHash String

  // Role & Permissions
  role UserRole @default(USER)

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Status
  isActive      Boolean @default(true)
  emailVerified Boolean @default(false)

  // Audit fields
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  auditLogs AuditLog[]

  @@index([email])
  @@index([role])
  @@index([organizationId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROPERTY_MANAGER
  ACCOUNTANT
  USER
}

model AuditLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  action   String // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity   String // Property, Unit, Lease, Invoice, etc.
  entityId String // The ID of the affected record

  details String? @db.Text // JSON or text description of changes

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// CORE ENTITIES (LANDLORDS & PROPERTIES)
// ============================================

model Landlord {
  id               String  @id @default(cuid())
  code             String  @unique
  name             String
  email            String?
  phone            String?
  alternativePhone String?

  // Address
  address    String? @db.Text
  city       String?
  country    String?
  postalCode String?

  // Banking Details
  bankName      String?
  bankBranch    String?
  accountName   String?
  accountNumber String?

  // Tax Information
  taxPin        String?
  vatRegistered Boolean @default(false)

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Relationships
  properties Property[]
  invoices   Invoice[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([code])
  @@index([email])
  @@index([organizationId])
  @@map("landlords")
}

model PropertyCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String? @db.Text
  code        String? @unique

  properties Property[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("property_categories")
}

model PropertyType {
  id          String  @id @default(cuid())
  name        String  @unique
  description String? @db.Text
  code        String? @unique

  properties Property[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("property_types")
}

model Property {
  id           String    @id @default(cuid())
  code         String    @unique // Property Code
  name         String // Property Name
  dateAcquired DateTime? // Date Acquired
  lrNumber     String? // LR Number (Land Registry Number)

  // Location & Address
  country       String?
  estateArea    String? // Estate/Area
  areaRegion    String? // Area/Region
  roadStreet    String? // Road/Street
  specification String? // Multi-unit/Multi-Space

  // Property Classification
  multiStoryType String? // Multi Story Type
  numberOfFloors Int? // No. Of Floors

  // Geographic Coordinates
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  // Notes & Contact Info
  notes               String? @db.Text // Property notes/description
  specificContactInfo String? @db.Text // Specific contact information

  // Relationships
  landlordId String?
  landlord   Landlord? @relation(fields: [landlordId], references: [id], onDelete: SetNull)

  categoryId String?
  category   PropertyCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  propertyTypeId String?
  propertyType   PropertyType? @relation(fields: [propertyTypeId], references: [id], onDelete: SetNull)

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Accounting & Billing Configuration
  accountLedgerType     String? // e.g., "Property Control Ledger in GL"
  primaryBankAccount    String? // Primary Bank/Account/Operating Account
  alternativeTaxPin     String? // Alternative Tax PIN
  propertyWorkingTaxPin String? // Property Working Tax PIN
  invoicePaymentInfo    String? @db.Text
  holderPaymentTerms    String? @db.Text

  // MPESA Configuration
  mpesaPropertyPayNumber   String?
  disableMpesaStkPush      Boolean @default(false)
  disableMpesaStkNarration Boolean @default(false)

  // Counters
  tenantReceiptAccountCodeCounter Int? @default(0)

  // Rent Penalty Configuration
  lpgExempted       Boolean @default(false)
  penaltyChargeMode String? // Penalty Charge Mode
  penaltyDay        Int? // Penalty Day

  // Landlord Banking Details
  landlordDrawerBank    String?
  landlordBankBranch    String?
  landlordAccountName   String?
  landlordAccountNumber String?

  // Communication Preferences
  exemptAllSms     Boolean @default(false)
  exemptInvoiceSms Boolean @default(false)
  exemptGeneralSms Boolean @default(false)
  exemptHagueSms   Boolean @default(false)
  exemptBalanceSms Boolean @default(false)

  exemptAllEmail     Boolean @default(false)
  exemptInvoiceEmail Boolean @default(false)
  exemptGeneralEmail Boolean @default(false)
  exemptReceiptEmail Boolean @default(false)
  exemptBalanceEmail Boolean @default(false)

  // Other Preferences
  excludeInTwoSummaryReport Boolean @default(false)

  // Related entities
  units            Unit[]
  standingCharges  PropertyStandingCharge[]
  securityDeposits PropertySecurityDeposit[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([landlordId])
  @@index([categoryId])
  @@index([propertyTypeId])
  @@index([code])
  @@index([organizationId])
  @@map("properties")
}

// ============================================
// UNITS & SPACES
// ============================================

model UnitType {
  id          String  @id @default(cuid())
  name        String  @unique
  description String? @db.Text

  units Unit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("unit_types")
}

model Unit {
  id       String @id @default(cuid())
  code     String @unique // Unit/Space No.
  name     String // Unit Name/Number
  sequence Int? // Unit Sequence

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Pricing
  quotedPrice     Decimal? @db.Decimal(10, 2)
  baseRent        Decimal? @db.Decimal(10, 2) // Market Rent
  basePerUnitArea Decimal? @db.Decimal(10, 2)
  currency        String   @default("KES")

  // Area/Space Management
  areaSqFt   Decimal? @db.Decimal(10, 2)
  chargePlan String?

  // Unit Details & Specifications
  floor            Int?
  bedrooms         Int? // Bedroom(s)
  bathrooms        Int? // Bathroom(s)
  furnished        Boolean @default(false)
  outSourceParking String? // Out Source/Parking

  unitTypeId String?
  unitType   UnitType? @relation(fields: [unitTypeId], references: [id], onDelete: SetNull)

  // Ownership
  ownerOccupied Boolean @default(false)

  // Utility Account & Billing Numbers
  electricityAcno    String?
  waterAcno          String?
  electricityMeethno String?
  waterMeethno       String?

  // Letting Details
  takeOnLettingDate DateTime?

  // Tenant/Resident Code Counter
  tenantResidentCodeCounter Int? @default(0)

  // Notes
  apartmentNotes String? @db.Text

  // Status
  status UnitStatus @default(VACANT)

  // Relationships
  leases         Lease[]
  serviceCharges UnitServiceCharge[]
  meterNumbers   UnitMeterNumber[]
  features       UnitFeature[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([propertyId])
  @@index([unitTypeId])
  @@index([status])
  @@map("units")
}

enum UnitStatus {
  VACANT
  OCCUPIED
  MAINTENANCE
  RESERVED
}

model UnitServiceCharge {
  id String @id @default(cuid())

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  serviceUtilityAmenity String // Service/Charge/Utility/Amenity name
  costPerArea           Decimal? @db.Decimal(10, 2)
  totalCost             Decimal  @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([unitId])
  @@map("unit_service_charges")
}

model UnitMeterNumber {
  id String @id @default(cuid())

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  meterNo      String
  readingSetup String? // Reading setup configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([unitId])
  @@map("unit_meter_numbers")
}

model UnitFeature {
  id String @id @default(cuid())

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  name        String
  featureType String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([unitId])
  @@map("unit_features")
}

// ============================================
// CHARGES & DEPOSITS
// ============================================

model PropertyStandingCharge {
  id String @id @default(cuid())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  chargeUtility    String // Charge/Utility name
  chargeMode       String // Billing mode
  billingCurrency  String   @default("KES")
  costPerArea      Decimal? @db.Decimal(10, 2)
  chargeValue      Decimal  @db.Decimal(10, 2)
  vatRate          Decimal? @db.Decimal(5, 2) // VAT percentage
  excludesWithRent Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@map("property_standing_charges")
}

model PropertySecurityDeposit {
  id String @id @default(cuid())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  month               String // Month identifier
  value               Decimal @db.Decimal(10, 2)
  ofRentBillingAmount Boolean @default(false)
  ofInitialRent       Boolean @default(false)
  ofLastEscalation    Boolean @default(false)
  excludesWithRent    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@map("property_security_deposits")
}

// ============================================
// TENANTS & LEASES
// ============================================

model Tenant {
  id            String @id @default(cuid())
  accountNumber String @unique // Account Number
  code          String @unique

  // Tenant Type & Personal Info
  tenantType String? // Individual, Corporate, etc.
  surname    String // Surname
  otherNames String? // Other Name(s)
  gender     String? // Gender

  // Contact Information
  email            String?
  phone            String // Mobile Number
  town             String?
  sendMobileNumber Boolean @default(false)

  // Identification & Tax
  idNoRegNo String? // ID No./REG No.
  taxPin    String? // Tax PIN

  // Address
  postalAddress String? @db.Text
  postalCode    String?
  country       String?

  // Photo
  photoUrl String? // URL to uploaded photo

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Relationships
  leases            Lease[]
  emergencyContacts TenantEmergencyContact[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([accountNumber])
  @@index([code])
  @@index([email])
  @@index([phone])
  @@index([organizationId])
  @@map("tenants")
}

model TenantEmergencyContact {
  id String @id @default(cuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactName  String
  relationship String?
  phone        String?
  email        String?

  // Priority (1 = primary, 2 = secondary)
  priority Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("tenant_emergency_contacts")
}

model Lease {
  id   String @id @default(cuid())
  code String @unique

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Restrict)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  // Lease Terms
  startDate  DateTime
  endDate    DateTime?
  rentAmount Decimal   @db.Decimal(10, 2)
  currency   String    @default("KES")
  paymentDay Int       @default(1) // Day of month rent is due

  // Security Deposit
  securityDeposit Decimal? @db.Decimal(10, 2)

  // Status
  status LeaseStatus @default(DRAFT)

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Relationships
  invoices Invoice[]
  payments Payment[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([unitId])
  @@index([tenantId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([organizationId])
  @@map("leases")
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
  RENEWED
}

// ============================================
// BILLING & PAYMENTS
// ============================================

model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String @unique

  // Landlord (recipient of invoice) - replaces lease reference
  landlordId String?
  landlord   Landlord? @relation(fields: [landlordId], references: [id], onDelete: SetNull)

  // Keep lease reference for backward compatibility and property tracking
  leaseId String?
  lease   Lease?  @relation(fields: [leaseId], references: [id], onDelete: SetNull)

  // Invoice Details
  issueDate   DateTime @default(now())
  dueDate     DateTime
  amount      Decimal  @db.Decimal(10, 2)
  vatAmount   Decimal? @db.Decimal(10, 2)
  totalAmount Decimal  @db.Decimal(10, 2)
  currency    String   @default("KES")

  // Transaction classification for accounting
  transactionClass String? // Transaction Class - for accounting classification

  // Accounts receivable for general ledger integration
  acReceivable String? // A/C Receivable - accounts receivable account // TODO Should be connected to another tabled

  // Billing address information
  billTo String? @db.Text // Bill To - billing address

  // Multi-currency support
  spotRate Decimal? @db.Decimal(10, 4) // Spot Rate - exchange rate for multi-currency

  // Purchase order tracking
  lpoNumber String? // LPO # - purchase order number

  // Digital signature tracking
  signOnEfims Boolean @default(false) // Sign On eFims - digital signature indicator

  // Payment instructions
  paymentInfo String? @db.Text // Payment Info - payment instructions

  // Terms and conditions
  termsConditions String? @db.Text // Terms & Conditions - invoice terms

  // Additional notes
  memo String? @db.Text // Memo - additional notes

  // Status
  status InvoiceStatus @default(PENDING)

  // Payment tracking
  paidAmount    Decimal @default(0) @db.Decimal(10, 2)
  balanceAmount Decimal @db.Decimal(10, 2)

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Relationships
  invoiceItems InvoiceItem[]
  payments     Payment[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leaseId])
  @@index([status])
  @@index([dueDate])
  @@index([organizationId])
  @@map("invoices")
}

model InvoiceItem {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Revenue/Expense item classification for accounting
  revenueExpenseItem String? // Revenue/Expense Item - for accounting categorization

  // Description of the line item (maps to "Particular" in form)
  description String // Particular - description of the line item

  // Income account for general ledger integration
  incomeAccount String? // Income Account - for general ledger integration

  // Quantity and pricing
  quantity  Decimal  @default(1) @db.Decimal(10, 2) // Qty - quantity of items
  unitPrice Decimal  @db.Decimal(10, 2) // Unit Cost - price per unit

  // Line total
  amount Decimal @db.Decimal(10, 2) // Line Total - total amount for this line

  // Tax information
  vatRate   Decimal? @db.Decimal(5, 2)  // Tax Rate - VAT percentage
  vatAmount Decimal? @db.Decimal(10, 2) // Tax Amount - calculated VAT amount

  // Additional classification
  className String? // Class - additional classification for reporting

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@map("invoice_items")
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id            String @id @default(cuid())
  receiptNumber String @unique

  leaseId String
  lease   Lease  @relation(fields: [leaseId], references: [id], onDelete: Restrict)

  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  // Payment Details
  paymentDate DateTime @default(now())
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("KES")

  // Payment Method
  paymentMethod    PaymentMethod
  paymentReference String? // Bank ref, M-Pesa code, etc.

  // MPESA specific
  mpesaReceiptNumber String?
  mpesaPhoneNumber   String?

  // Notes
  notes String? @db.Text

  // Organization/Tenant association
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leaseId])
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([paymentMethod])
  @@index([organizationId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  MPESA
  CARD
  OTHER
}
